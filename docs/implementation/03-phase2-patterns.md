# Phase 2: æ¨¡å¼è¯†åˆ«å¼•æ“

**ç›®æ ‡**: å®ç° AI é©±åŠ¨çš„æ¨¡å¼è¯†åˆ«å¼•æ“ï¼Œè‡ªåŠ¨å‘ç°ç”¨æˆ·çš„é‡å¤æ“ä½œæ¨¡å¼å¹¶å»ºè®®è‡ªåŠ¨åŒ–

**é¢„è®¡æ—¶é—´**: 20-25 å¤©

---

## ğŸ“‹ æ¦‚è¿°

æœ¬é˜¶æ®µæ˜¯ FlowMind çš„**æ ¸å¿ƒåˆ›æ–°åŠŸèƒ½**ï¼Œå°†å®ç°ï¼š

1. **äº‹ä»¶åºåˆ—å­˜å‚¨** - å°†ç›‘æ§äº‹ä»¶æŒä¹…åŒ–åˆ° SQLite æ•°æ®åº“
2. **ä¼šè¯åˆ’åˆ†** - å°†äº‹ä»¶æŒ‰æ—¶é—´çª—å£åˆ†ç»„ï¼Œè¯†åˆ«å·¥ä½œä¼šè¯
3. **æ¨¡å¼æŒ–æ˜** - ä½¿ç”¨ PrefixSpan ç®—æ³•è¯†åˆ«é¢‘ç¹åºåˆ—
4. **AI è¿‡æ»¤** - ä½¿ç”¨ Claude API åˆ¤æ–­æ¨¡å¼æ˜¯å¦å€¼å¾—è‡ªåŠ¨åŒ–
5. **æ¨¡å¼å»ºè®®** - å‘ç”¨æˆ·å±•ç¤ºå‘ç°çš„æ¨¡å¼å¹¶ç”Ÿæˆè‡ªåŠ¨åŒ–å»ºè®®

### ç³»ç»Ÿæ¶æ„

```
Monitor Engine (å·²å®ç°)
    â†“ å‘å¸ƒäº‹ä»¶
Event Bus (pkg/events)
    â†“ è®¢é˜…äº‹ä»¶
Analyzer Engine (æ–°å¢)
  â”œâ”€ EventRepository    # äº‹ä»¶æŒä¹…åŒ– (SQLite)
  â”œâ”€ SessionDivider     # ä¼šè¯åˆ’åˆ† (æ—¶é—´çª—å£)
  â”œâ”€ PatternMiner       # PrefixSpan ç®—æ³•
  â”œâ”€ AIPatternFilter    # Claude API é›†æˆ
  â””â”€ PatternRecommender # å»ºè®®ç”Ÿæˆ
    â†“ è¾“å‡ºæ¨¡å¼å»ºè®®
Frontend UI
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### Step 1: æ·»åŠ ä¾èµ– (1 å¤©)

**ä»»åŠ¡æ¸…å•**:
- [ ] æ›´æ–° `go.mod` æ·»åŠ ä¾èµ–:
  ```bash
  go get github.com/mattn/go-sqlite3
  go get go.etcd.io/bbolt
  go get github.com/philippgille/chromem-go
  go mod tidy
  ```
- [ ] éªŒè¯ä¾èµ–å®‰è£…: `go build ./...`

**éªŒè¯æ ‡å‡†**:
- æ‰€æœ‰ä¾èµ–å®‰è£…æˆåŠŸ
- é¡¹ç›®å¯ä»¥æ­£å¸¸ç¼–è¯‘

---

### Step 2: å®ç°å­˜å‚¨å±‚ (3-4 å¤©)

#### Day 1: SQLite åŸºç¡€è®¾æ–½

**æ–‡ä»¶ç»“æ„**:
```
internal/storage/
â”œâ”€â”€ sqlite.go                  # SQLite è¿æ¥ç®¡ç†
â”œâ”€â”€ migrations.go              # è¿ç§»æ‰§è¡Œå™¨
â””â”€â”€ migrations/
    â””â”€â”€ 001_init.sql           # events è¡¨
```

**å…³é”®åŠŸèƒ½**:
- SQLite æ•°æ®åº“è¿æ¥ç®¡ç†ï¼ˆWAL æ¨¡å¼ä¼˜åŒ–ï¼‰
- æ•°æ®åº“è¿ç§»ç³»ç»Ÿ
- events è¡¨åˆ›å»ºï¼ˆåŒ…å«å®Œæ•´ç´¢å¼•ï¼‰

**è¯¦ç»†å®ç°**: å‚è§ [å­˜å‚¨å±‚æ¶æ„æ–‡æ¡£](../architecture/06-storage-layer.md)

**éªŒè¯æ ‡å‡†**:
- [ ] æ•°æ®åº“è¿æ¥æˆåŠŸ
- [ ] è¿ç§»æ‰§è¡ŒæˆåŠŸ
- [ ] events è¡¨åˆ›å»ºæˆåŠŸ
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

---

#### Day 2: EventRepository

**æ–‡ä»¶ç»“æ„**:
```
internal/storage/
â””â”€â”€ event_repository.go        # äº‹ä»¶ä»“å‚¨æ¥å£
```

**æ ¸å¿ƒæ¥å£**:
- `Save()` - ä¿å­˜å•ä¸ªäº‹ä»¶
- `SaveBatch()` - æ‰¹é‡ä¿å­˜ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- `FindByTimeRange()` - æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
- `FindRecent()` - æŸ¥è¯¢æœ€è¿‘çš„äº‹ä»¶
- `FindByType()` - æŒ‰ç±»å‹æŸ¥è¯¢
- `DeleteOlderThan()` - åˆ é™¤æ—§æ•°æ®
- `GetStats()` - è·å–ç»Ÿè®¡ä¿¡æ¯

**æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨äº‹åŠ¡å’Œé¢„å¤„ç†è¯­å¥ä¼˜åŒ–æ‰¹é‡å†™å…¥

**è¯¦ç»†å®ç°**: å‚è§ [å­˜å‚¨å±‚æ¶æ„æ–‡æ¡£](../architecture/06-storage-layer.md)

**éªŒè¯æ ‡å‡†**:
- [ ] æ‰€æœ‰æ¥å£å®ç°å®Œæˆ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 90%
- [ ] æ‰¹é‡å†™å…¥æ€§èƒ½ > 1000 events/sec

---

#### Day 3: è¿ç§»è„šæœ¬

**æ–‡ä»¶ç»“æ„**:
```
internal/storage/migrations/
â”œâ”€â”€ 002_add_sessions.sql       # sessions è¡¨
â”œâ”€â”€ 003_add_patterns.sql       # patterns è¡¨
â”œâ”€â”€ 004_add_automations.sql    # automations è¡¨
â”œâ”€â”€ 005_add_ai_cache.sql       # AI ç¼“å­˜è¡¨
â””â”€â”€ 006_schema_migrations.sql  # è¿ç§»è®°å½•è¡¨
```

**è¡¨ç»“æ„**: sessionsã€patternsã€automationsã€AI ç¼“å­˜ç­‰

**è¯¦ç»†å®ç°**: å‚è§ [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](../design/01-database-design.md)

---

#### Day 4: æ€§èƒ½ä¼˜åŒ–

**æ–‡ä»¶ç»“æ„**:
```
internal/storage/
â””â”€â”€ batch_writer.go            # æ‰¹é‡å†™å…¥å™¨
```

**æ ¸å¿ƒåŠŸèƒ½**:
- æ‰¹é‡æ”¶é›†äº‹ä»¶ï¼ˆ100 æ¡ä¸€æ‰¹ï¼‰
- å®šæ—¶åˆ·æ–°æœºåˆ¶ï¼ˆ5 ç§’ï¼‰
- å¼‚æ­¥å†™å…¥ä¼˜åŒ–

**è¯¦ç»†å®ç°**: å‚è§ [å­˜å‚¨å±‚æ¶æ„æ–‡æ¡£](../architecture/06-storage-layer.md)

**éªŒè¯æ ‡å‡†**:
- [ ] æ‰¹é‡å†™å…¥æ€§èƒ½è¾¾æ ‡
- [ ] å†…å­˜ä½¿ç”¨åˆç†
- [ ] å‹åŠ›æµ‹è¯•é€šè¿‡ (1000 events/sec)

---

### Step 3: é›†æˆå­˜å‚¨å±‚åˆ° Monitor Engine (1 å¤©)

**ä¿®æ”¹æ–‡ä»¶**: `internal/monitor/engine.go`

**å…³é”®æ”¹åŠ¨**:
- æ·»åŠ  `eventRepo` å’Œ `batchWriter` å­—æ®µ
- åœ¨ Start() æ–¹æ³•ä¸­è®¢é˜…æ‰€æœ‰äº‹ä»¶å¹¶æŒä¹…åŒ–
- ä½¿ç”¨æ‰¹é‡å†™å…¥å™¨ä¼˜åŒ–æ€§èƒ½

**è¯¦ç»†å®ç°**: å‚è§ [ç›‘æ§å¼•æ“æ¶æ„æ–‡æ¡£](../architecture/02-monitor-engine.md)

**éªŒè¯æ ‡å‡†**:
- [ ] ç›‘æ§äº‹ä»¶è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
- [ ] å¯ä»¥æŸ¥è¯¢ä¿å­˜çš„äº‹ä»¶
- [ ] æ€§èƒ½æ— æ˜æ˜¾å½±å“

---

### Step 4: å®ç° SessionDivider (2 å¤©)

**æ–‡ä»¶ç»“æ„**:
```
internal/analyzer/
â”œâ”€â”€ types.go                   # å…±äº«ç±»å‹å®šä¹‰
â””â”€â”€ session.go                 # ä¼šè¯åˆ’åˆ†é€»è¾‘
```

**æ ¸å¿ƒåŠŸèƒ½**:
- `Session` - ä¼šè¯å®šä¹‰ï¼ˆIDã€æ—¶é—´ã€åº”ç”¨ã€äº‹ä»¶åˆ—è¡¨ï¼‰
- `SessionDivider` - ä¼šè¯åˆ’åˆ†å™¨æ¥å£
- `TimeBasedDivider` - åŸºäºæ—¶é—´çš„åˆ’åˆ†å®ç°

**åˆ’åˆ†ç­–ç•¥**:
- è¶…æ—¶æ£€æµ‹ï¼ˆ10 åˆ†é’Ÿæ— æ“ä½œï¼‰
- åº”ç”¨åˆ‡æ¢æ£€æµ‹ï¼ˆå¯é€‰ï¼‰

**è¯¦ç»†å®ç°**: å‚è§ [åˆ†æå¼•æ“æ¶æ„æ–‡æ¡£](../architecture/03-analyzer-engine.md)

**éªŒè¯æ ‡å‡†**:
- [ ] æ­£ç¡®åˆ’åˆ†ä¼šè¯
- [ ] è¶…æ—¶æ£€æµ‹å‡†ç¡®
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

---

### Step 5: å®ç° PatternMiner (3-4 å¤©)

**æ–‡ä»¶ç»“æ„**:
```
internal/analyzer/
â”œâ”€â”€ normalizer.go              # äº‹ä»¶æ ‡å‡†åŒ–
â”œâ”€â”€ prefixspan.go              # PrefixSpan ç®—æ³•
â””â”€â”€ pattern_miner.go           # æ¨¡å¼æŒ–æ˜å™¨
```

#### Day 1: äº‹ä»¶æ ‡å‡†åŒ–

**åŠŸèƒ½**:
- å°†åŸå§‹äº‹ä»¶è½¬æ¢ä¸ºæŠ½è±¡çš„ EventStep
- æå–å…³é”®ç‰¹å¾ï¼ˆæŒ‰é”®ç±»å‹ã€åº”ç”¨ç­‰ï¼‰

#### Day 2: PrefixSpan ç®—æ³•

**æ ¸å¿ƒç®—æ³•**:
- é€’å½’æŒ–æ˜é¢‘ç¹åºåˆ—æ¨¡å¼
- æŠ•å½±æ•°æ®åº“ä¼˜åŒ–
- æ”¯æŒåº¦è®¡ç®—å’Œå‰ªæ

**è¯¦ç»†å®ç°**: å‚è§ [åˆ†æå¼•æ“æ¶æ„æ–‡æ¡£](../architecture/03-analyzer-engine.md)

**éªŒè¯æ ‡å‡†**:
- [ ] ç®—æ³•æ­£ç¡®æ€§éªŒè¯
- [ ] æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•

---

### Step 6: å®ç° AI Service (2-3 å¤©)

**æ–‡ä»¶ç»“æ„**:
```
internal/ai/
â”œâ”€â”€ claude_client.go           # Claude API å®¢æˆ·ç«¯
â”œâ”€â”€ pattern_filter.go          # æ¨¡å¼è¿‡æ»¤
â””â”€â”€ prompts.go                 # æç¤ºè¯æ¨¡æ¿
```

#### Day 1: Claude å®¢æˆ·ç«¯

**æ ¸å¿ƒåŠŸèƒ½**:
- Claude API è°ƒç”¨å°è£…
- é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
- è¯·æ±‚/å“åº”æ¨¡å‹å®šä¹‰

#### Day 2: æç¤ºè¯æ¨¡æ¿

**åŠŸèƒ½**:
- æ¨¡å¼åˆ†ææç¤ºè¯ç”Ÿæˆ
- AI å“åº”è§£æ
- æ—¶é—´èŠ‚çœä¼°ç®—

#### Day 3: æ¨¡å¼è¿‡æ»¤

**åŠŸèƒ½**:
- `AIPatternFilter` - AI æ¨¡å¼è¿‡æ»¤å™¨æ¥å£
- `ShouldAutomate()` - åˆ¤æ–­æ¨¡å¼æ˜¯å¦å€¼å¾—è‡ªåŠ¨åŒ–
- ç¼“å­˜æœºåˆ¶å’Œé™æµæ§åˆ¶

**è¯¦ç»†å®ç°**: å‚è§ [AI æœåŠ¡æ¶æ„æ–‡æ¡£](../architecture/04-ai-service.md)

---

### Step 7: å®ç° Analyzer Engine ä¸»å¼•æ“ (2 å¤©)

**æ–‡ä»¶ç»“æ„**:
```
internal/analyzer/
â”œâ”€â”€ engine.go                  # ä¸»å¼•æ“
â””â”€â”€ config.go                  # é…ç½®ç®¡ç†
```

**æ ¸å¿ƒç»„ä»¶**:
- `Engine` - åˆ†æå¼•æ“ä¸»ç±»
- äº‹ä»¶å¤„ç†å¾ªç¯
- æ¨¡å¼æŒ–æ˜å¾ªç¯
- AI è¿‡æ»¤å¾ªç¯

**å·¥ä½œæµç¨‹**:
1. è®¢é˜…ç›‘æ§äº‹ä»¶å¹¶æŒä¹…åŒ–
2. å®šæ—¶æŒ–æ˜æ¨¡å¼ï¼ˆå¯é…ç½®é—´éš”ï¼‰
3. ä½¿ç”¨ AI è¿‡æ»¤æ¨¡å¼
4. ç”Ÿæˆè‡ªåŠ¨åŒ–å»ºè®®

**è¯¦ç»†å®ç°**: å‚è§ [åˆ†æå¼•æ“æ¶æ„æ–‡æ¡£](../architecture/03-analyzer-engine.md)

---

### Step 8-11: å‰ç«¯é›†æˆã€æµ‹è¯•ã€éƒ¨ç½²

è¯¦è§å®æ–½è®¡åˆ’æ–‡æ¡£ã€‚

---

## âœ… éªŒè¯æ ‡å‡†

### åŠŸèƒ½éªŒè¯
- [ ] èƒ½è®°å½•ç”¨æˆ·æ‰€æœ‰å…³é”®æ“ä½œ
- [ ] èƒ½æ£€æµ‹åˆ°ç”¨æˆ·é‡å¤æ“ä½œï¼ˆå¦‚å¯åŠ¨å¼€å‘ç¯å¢ƒï¼‰
- [ ] AI æ­£ç¡®åˆ¤æ–­å“ªäº›æ¨¡å¼å€¼å¾—è‡ªåŠ¨åŒ–
- [ ] UI æ˜¾ç¤ºè‡ªåŠ¨åŒ–å»ºè®®åˆ—è¡¨
- [ ] ç”¨æˆ·å¯ä»¥æ¥å—/æ‹’ç»å»ºè®®

### æ€§èƒ½éªŒè¯
- [ ] äº‹ä»¶æŒä¹…åŒ–: >1000 events/sec
- [ ] æ¨¡å¼æŒ–æ˜: <5s å¤„ç† 1000 äº‹ä»¶
- [ ] å†…å­˜å ç”¨: <100MB
- [ ] CPU ä½¿ç”¨: <10% (ç©ºé—²æ—¶)

### è´¨é‡éªŒè¯
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥80%
- [ ] æ ¸å¿ƒæ¨¡å—è¦†ç›–ç‡ â‰¥90%
- [ ] æ‰€æœ‰ä¸­æ–‡æ³¨é‡Šå®Œæ•´
- [ ] æ–‡æ¡£å®Œæ•´

---

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

1. **å‡†ç¡®æ€§**: èƒ½å‘ç° 90% çš„é‡å¤æ“ä½œæ¨¡å¼
2. **æ€§èƒ½**: åˆ†æ 1 å¤©æ•°æ® <5 ç§’
3. **å®ç”¨æ€§**: AI å»ºè®®çš„è‡ªåŠ¨åŒ–æ¥å—ç‡ >70%
4. **ç¨³å®šæ€§**: è¿ç»­è¿è¡Œ 7 å¤©æ— å´©æºƒ

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

**å‰ç½®æ–‡æ¡£**ï¼ˆä¸Šä¸‹é˜¶æ®µï¼‰:
- [ç³»ç»Ÿæ¶æ„æ€»è§ˆ](../architecture/00-system-architecture.md) - ç†è§£æ•´ä½“æ¶æ„å’Œåˆ†å±‚è®¾è®¡
- [Phase 1: åŸºç¡€ç›‘æ§](./02-phase1-monitoring.md) - å®ç°äº‹ä»¶ç›‘æ§å’Œæ•°æ®é‡‡é›†
- [å¼€å‘ç¯å¢ƒæ­å»º](./01-development-setup.md) - é…ç½®å¼€å‘ç¯å¢ƒ

**æœ¬é˜¶æ®µè¯¦ç»†æ¶æ„**:
- [åˆ†æå¼•æ“è¯¦è§£](../architecture/03-analyzer-engine.md) - æ¨¡å¼æŒ–æ˜å’Œåºåˆ—åˆ†æ
- [AI æœåŠ¡è¯¦è§£](../architecture/04-ai-service.md) - Claude API é›†æˆå’Œæç¤ºè¯å·¥ç¨‹
- [å­˜å‚¨å±‚è¯¦è§£](../architecture/06-storage-layer.md) - æ•°æ®åº“è®¾è®¡å’Œæ‰¹é‡å†™å…¥ä¼˜åŒ–

**è®¾è®¡æ–‡æ¡£**:
- [æ•°æ®åº“è®¾è®¡](../design/01-database-design.md) - å®Œæ•´çš„æ•°æ®åº“ Schema

**åç»­é˜¶æ®µ**ï¼ˆä¸‹é˜¶æ®µï¼‰:
- [Phase 3: AI åŠ©æ‰‹](./04-phase3-assistant.md) - å®ç° AI é¢æ¿å’Œç”¨æˆ·äº¤äº’

---

**æœ€åæ›´æ–°**: 2026-01-30
